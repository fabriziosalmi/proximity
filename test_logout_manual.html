<!DOCTYPE html>
<html>
<head>
    <title>Test Logout Manual</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        button { 
            background: #0a0; 
            color: #000; 
            border: none; 
            padding: 10px 20px; 
            cursor: pointer; 
            margin: 5px;
            font-size: 16px;
        }
        button:hover { background: #0f0; }
        .output { 
            background: #000; 
            padding: 10px; 
            margin: 10px 0; 
            border: 1px solid #0a0;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <h1>üîê Proximity Logout Test</h1>
    
    <div>
        <h3>Step 1: Create User & Login</h3>
        <input type="text" id="username" placeholder="Username" value="testlogout_user">
        <input type="password" id="password" placeholder="Password" value="testpass123">
        <button onclick="createAndLogin()">Create & Login</button>
    </div>
    
    <div>
        <h3>Step 2: Check Auth Status</h3>
        <button onclick="checkAuth()">Check localStorage</button>
    </div>
    
    <div>
        <h3>Step 3: Logout via API</h3>
        <button onclick="testLogout()">Clear localStorage (simulate logout)</button>
    </div>
    
    <div class="output" id="output">Ready...</div>
    
    <script>
        const API_BASE = 'http://localhost:8000';
        let token = null;
        
        async function createAndLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            log('Creating user...');
            try {
                const createRes = await fetch(`${API_BASE}/api/core/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, email: `${username}@test.com` })
                });
                
                if (createRes.ok) {
                    log('‚úÖ User created');
                } else {
                    log(`‚ö†Ô∏è User might exist: ${createRes.status}`);
                }
            } catch (e) {
                log('‚ö†Ô∏è Create error (might be OK if user exists)');
            }
            
            log('Logging in...');
            const loginRes = await fetch(`${API_BASE}/api/core/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            
            if (loginRes.ok) {
                const data = await loginRes.json();
                token = data.access;
                localStorage.setItem('access_token', token);
                localStorage.setItem('user', JSON.stringify({ username }));
                log(`‚úÖ Logged in! Token: ${token.substring(0, 20)}...`);
            } else {
                log(`‚ùå Login failed: ${loginRes.status}`);
            }
        }
        
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            const user = localStorage.getItem('user');
            
            if (token) {
                log(`‚úÖ Token in localStorage: ${token.substring(0, 30)}...`);
                log(`‚úÖ User in localStorage: ${user}`);
            } else {
                log('‚ùå No token in localStorage');
            }
        }
        
        function testLogout() {
            log('Clearing localStorage (simulating logout)...');
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            token = null;
            log('‚úÖ localStorage cleared');
            checkAuth();
        }
        
        function log(msg) {
            const output = document.getElementById('output');
            output.innerHTML += `\n${new Date().toLocaleTimeString()} - ${msg}`;
            output.scrollTop = output.scrollHeight;
        }
    </script>
</body>
</html>
