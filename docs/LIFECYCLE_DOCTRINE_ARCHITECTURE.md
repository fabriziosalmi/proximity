# Lifecycle & Consistency Doctrine - Architecture Diagram

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    PROXIMITY LIFECYCLE MANAGEMENT ENGINE                     โ
โ                         (Unified & Intelligent)                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

                                                                                
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                          APPLICATION TYPES                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                              โ
โ  ๐ฆ NATIVE/DEPLOYED APPS          โ  ๐ ADOPTED APPS                        โ
โ  โข Created by Proximity            โ  โข Imported from Proxmox               โ
โ  โข Fully managed                   โ  โข Soft-managed                        โ
โ  โข config.adopted = False          โ  โข config.adopted = True               โ
โ  โข Hard delete on removal          โ  โข Soft delete on removal              โ
โ                                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     DOCTRINE #1: ADOPTION-AWARE DELETION                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                              โ
โ  DELETE REQUEST                                                              โ
โ       โ                                                                      โ
โ       โโโโโโโโบ Check: is_adopted?                                           โ
โ       โ              โ                                                       โ
โ       โ              โโโโ TRUE โโโบ ๐งน SOFT DELETE                           โ
โ       โ              โ                  โข Release ports                      โ
โ       โ              โ                  โข Delete DB record                   โ
โ       โ              โ                  โข โ Container preserved             โ
โ       โ              โ                                                       โ
โ       โ              โโโโ FALSE โโบ ๐๏ธ  HARD DELETE                          โ
โ       โ                                 โข Stop container                     โ
โ       โ                                 โข Delete container                   โ
โ       โ                                 โข Release ports                      โ
โ       โ                                 โข Delete DB record                   โ
โ       โ                                                                      โ
โ       โโโโโโโโบ Log strategy & execute                                       โ
โ                                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                DOCTRINE #2: INTELLIGENT RECONCILIATION                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                              โ
โ  RECONCILIATION CYCLE                                                        โ
โ       โ                                                                      โ
โ       โโโโโโโโบ 1. Fetch all VMIDs from Proxmox                              โ
โ       โ                                                                      โ
โ       โโโโโโโโบ 2. Fetch all apps from DB                                    โ
โ       โ                                                                      โ
โ       โโโโโโโโบ 3. Identify orphans (DB but not Proxmox)                     โ
โ       โ                                                                      โ
โ       โโโโโโโโบ 4. Classify orphans:                                         โ
โ                     โ                                                        โ
โ                     โโโโ status in [removing, error]                        โ
โ                     โ          โ                                             โ
โ                     โ    โ EXPECTED ORPHAN                                  โ
โ                     โ    โข Log: INFO                                         โ
โ                     โ    โข Clean silently                                    โ
โ                     โ                                                        โ
โ                     โโโโ status in [running, stopped, ...]                  โ
โ                              โ                                               โ
โ                        ๐จ ANOMALOUS ORPHAN                                   โ
โ                        โข Log: CRITICAL                                       โ
โ                        โข Alert: Sentry                                       โ
โ                        โข Clean safely                                        โ
โ                                                                              โ
โ       All cleanups are SOFT (DB/ports only, never touch Proxmox)            โ
โ                                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 DOCTRINE #3: CONSERVATIVE JANITOR                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                              โ
โ  JANITOR CYCLE (Every 1 hour)                                               โ
โ       โ                                                                      โ
โ       โโโโโโโโบ 1. Find apps in transitional states                          โ
โ       โ           [deploying, cloning, removing, updating]                  โ
โ       โ                                                                      โ
โ       โโโโโโโโบ 2. Check if stuck > timeout threshold                        โ
โ       โ                                                                      โ
โ       โโโโโโโโบ 3. Mark as ERROR (ONLY!)                                     โ
โ                     โข Update status to 'error'                               โ
โ                     โข Log timeout message                                    โ
โ                     โข โ NEVER delete containers                             โ
โ                     โข โ Let reconciler handle cleanup                       โ
โ                                                                              โ
โ  ๐ฉบ DOCTOR MODE: Diagnose, don't execute                                    โ
โ                                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   DOCTRINE #4: INFORMED ADOPTION                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                              โ
โ  ADOPTION PROCESS                                                            โ
โ       โ                                                                      โ
โ       โโโโโโโโบ 1. Connect to Proxmox                                        โ
โ       โ                                                                      โ
โ       โโโโโโโโบ 2. Get basic container info                                  โ
โ       โ           โข Name, status, resources                                 โ
โ       โ                                                                      โ
โ       โโโโโโโโบ 3. ๐ธ CAPTURE CONFIG SNAPSHOT                                โ
โ       โ           โข Full 'pct config' output                                โ
โ       โ           โข Network configuration                                   โ
โ       โ           โข Resource allocation                                     โ
โ       โ                                                                      โ
โ       โโโโโโโโบ 4. Detect/specify ports                                      โ
โ       โ                                                                      โ
โ       โโโโโโโโบ 5. Allocate public port                                      โ
โ       โ                                                                      โ
โ       โโโโโโโโบ 6. Create Application with RICH metadata:                    โ
โ       โ           โข adopted: true                                            โ
โ       โ           โข proxmox_config_snapshot: {...}                          โ
โ       โ           โข resources_at_adoption: {...}                            โ
โ       โ           โข status_at_adoption: 'running'                           โ
โ       โ                                                                      โ
โ       โโโโโโโโบ 7. Set status to ACTUAL Proxmox state                        โ
โ                                                                              โ
โ  ๐ Result: Complete "clinical record" for troubleshooting                  โ
โ                                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      SEPARATION OF CONCERNS                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                              โ
โ  ๐ฉบ JANITOR SERVICE                                                          โ
โ     Responsibility: INTERNAL state health                                   โ
โ     โข Monitors transitional states                                          โ
โ     โข Marks stuck apps as error                                             โ
โ     โข Never touches external resources                                      โ
โ                                                                              โ
โ  ๐ RECONCILIATION SERVICE                                                   โ
โ     Responsibility: EXTERNAL state consistency                              โ
โ     โข Syncs DB with Proxmox                                                 โ
โ     โข Cleans up orphaned records                                            โ
โ     โข Detects anomalies                                                     โ
โ                                                                              โ
โ  ๐๏ธ  DELETE TASK                                                             โ
โ     Responsibility: LIFECYCLE termination                                   โ
โ     โข Respects adoption status                                              โ
โ     โข Executes appropriate strategy                                         โ
โ     โข Ensures complete cleanup                                              โ
โ                                                                              โ
โ  ๐ ADOPT TASK                                                               โ
โ     Responsibility: ONBOARDING existing resources                           โ
โ     โข Captures complete metadata                                            โ
โ     โข Creates management record                                             โ
โ     โข Preserves original configuration                                      โ
โ                                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         STATE FLOW DIAGRAM                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                              โ
โ                          โโโโโโโโโโโโ                                        โ
โ                          โ adopting โ  (Adoption in progress)               โ
โ                          โโโโโโฌโโโโโโ                                        โ
โ                               โ                                              โ
โ                               โโโโบ running  (If container was running)      โ
โ                               โโโโบ stopped  (If container was stopped)      โ
โ                                                                              โ
โ  โโโโโโโโโโโโ                                                               โ
โ  โdeploying โ  (Native app being created)                                   โ
โ  โโโโโโฌโโโโโโ                                                               โ
โ       โ                                                                      โ
โ       โโโโบ running  (Success)                                               โ
โ       โโโโบ error    (Failure or timeout - Janitor marks)                    โ
โ       โโโโบ [removed] (Manual Proxmox deletion - Reconciler detects)         โ
โ                                                                              โ
โ  โโโโโโโโโโโ                                                                โ
โ  โ running โ  (Stable state)                                                โ
โ  โโโโโโฌโโโโโ                                                                โ
โ       โ                                                                      โ
โ       โโโโบ stopped  (User action)                                           โ
โ       โโโโบ removing (Delete requested)                                      โ
โ       โโโโบ [orphan]  (Manual Proxmox deletion โ ALERT!)                     โ
โ                                                                              โ
โ  โโโโโโโโโโโโ                                                               โ
โ  โ removing โ  (Deletion in progress)                                       โ
โ  โโโโโโฌโโโโโโ                                                               โ
โ       โ                                                                      โ
โ       โโโโบ [deleted]  (Success - record removed)                            โ
โ       โโโโบ error      (Failure - Janitor marks if stuck)                    โ
โ       โโโโบ [orphan]   (Expected if container deleted)                       โ
โ                                                                              โ
โ  โโโโโโโโโ                                                                  โ
โ  โ error โ  (Terminal failure state)                                        โ
โ  โโโโโฌโโโโ                                                                  โ
โ      โ                                                                       โ
โ      โโโโบ [orphan]  (If container manually removed - Expected)              โ
โ                                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                           LOGGING PATTERNS                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                              โ
โ  Deletion:                                                                   โ
โ    ๐ SOFT DELETE โ "Removing Proximity management (container preserved)"   โ
โ    ๐๏ธ  HARD DELETE โ "Destroying container and cleaning up resources"       โ
โ                                                                              โ
โ  Reconciliation:                                                             โ
โ    โ "EXPECTED ORPHAN: Container removal expected"                          โ
โ    ๐จ "ANOMALOUS ORPHAN DETECTED: Container was MANUALLY DELETED"            โ
โ                                                                              โ
โ  Janitor:                                                                    โ
โ    ๐ฉบ "DIAGNOSING: ... Stuck for Xh Ym"                                     โ
โ    โ "DIAGNOSED AS ERROR: ... (was: deploying)"                             โ
โ    โ "Container (if any) will be handled by ReconciliationService"          โ
โ                                                                              โ
โ  Adoption:                                                                   โ
โ    ๐ธ "Capturing complete container configuration snapshot..."               โ
โ    โ "Config snapshot: X keys captured"                                     โ
โ    โ "INFORMED ADOPTION COMPLETED SUCCESSFULLY"                             โ
โ                                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                            KEY BENEFITS                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                              โ
โ  ๐ SAFETY          No accidental container destruction                     โ
โ  ๐ฏ INTELLIGENCE    Context-aware decision making                           โ
โ  ๐ VISIBILITY      Clear audit trail for all operations                    โ
โ  โก RESILIENCE      Graceful handling of edge cases                         โ
โ  ๐งฉ MODULARITY      Clear separation of concerns                            โ
โ  ๐ OBSERVABILITY   Rich metrics and monitoring                             โ
โ                                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```
