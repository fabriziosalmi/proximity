<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentry Test - Semplificato</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-top: 0; }
        button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { background: #c0392b; }
        .info { 
            background: #e8f4f8; 
            padding: 15px; 
            border-radius: 4px; 
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.loading { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>üß™ Sentry Test - Debug</h1>
        
        <div id="status" class="status loading">‚è≥ Caricamento Sentry...</div>
        
        <div class="info">
            <strong>üìã Checklist:</strong>
            <ul id="checklist">
                <li>‚è≥ Caricamento SDK...</li>
                <li>‚è≥ Inizializzazione...</li>
                <li>‚è≥ Configurazione...</li>
            </ul>
        </div>

        <div>
            <button onclick="testBasicError()">1Ô∏è‚É£ Test Errore Base</button>
            <button onclick="testWithContext()">2Ô∏è‚É£ Test con Contesto</button>
            <button onclick="testException()">3Ô∏è‚É£ Test Exception</button>
        </div>

        <div id="output"></div>
    </div>

    <script>
        // Define ALL functions before SDK loads
        let sentryReady = false;

        function updateChecklist(index, status, text) {
            const items = document.querySelectorAll('#checklist li');
            if (items[index]) {
                const icon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚è≥';
                items[index].innerHTML = `${icon} ${text}`;
            }
        }

        function updateStatus(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }

        function log(message, data) {
            const output = document.getElementById('output');
            const entry = document.createElement('pre');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (data) {
                entry.textContent += '\n' + JSON.stringify(data, null, 2);
            }
            output.appendChild(entry);
            console.log(message, data);
        }

        function handleSdkError() {
            updateChecklist(0, 'error', 'Errore caricamento SDK');
            updateStatus('error', '‚ùå Errore caricamento Sentry SDK');
            log('ERROR: Impossibile caricare Sentry SDK da CDN');
        }

        function initSentry() {
            try {
                updateChecklist(0, 'success', 'SDK caricato');
                log('‚úÖ Sentry SDK caricato');

                // Check if Sentry is available
                if (typeof Sentry === 'undefined') {
                    throw new Error('Sentry object non disponibile');
                }

                // Initialize Sentry
                Sentry.init({
                    dsn: "https://dbee00d4782d131ab54ffe60b16d969b@o149725.ingest.us.sentry.io/4508703059443712",
                    environment: "test",
                    debug: true,
                    tracesSampleRate: 1.0,
                    replaysSessionSampleRate: 0.1,
                    replaysOnErrorSampleRate: 1.0,
                    
                    beforeSend(event) {
                        log('üì§ Invio evento a Sentry', { eventId: event.event_id });
                        return event;
                    },

                    integrations: [
                        Sentry.replayIntegration(),
                    ],
                });

                updateChecklist(1, 'success', 'Inizializzazione completata');
                log('‚úÖ Sentry.init() completato');

                // Set user context
                Sentry.setUser({
                    email: "test@proximity.local",
                    id: "test-user",
                    username: "Test User"
                });

                updateChecklist(2, 'success', 'Configurazione completata');
                updateStatus('success', '‚úÖ Sentry pronto!');
                log('‚úÖ Configurazione utente completata');
                
                sentryReady = true;

            } catch (error) {
                updateChecklist(1, 'error', `Errore inizializzazione: ${error.message}`);
                updateStatus('error', '‚ùå Errore inizializzazione Sentry');
                log('ERROR durante inizializzazione', { error: error.message, stack: error.stack });
                console.error('Sentry init error:', error);
            }
        }

        function testBasicError() {
            if (!sentryReady) {
                alert('Sentry non ancora pronto!');
                return;
            }

            try {
                log('üöÄ Test 1: Invio errore base...');
                updateStatus('loading', '‚è≥ Invio errore...');

                const eventId = Sentry.captureMessage('Test errore base da Proximity', 'error');
                
                log('‚úÖ Errore inviato!', { eventId });
                updateStatus('success', `‚úÖ Errore inviato! Event ID: ${eventId}`);
                
                setTimeout(() => {
                    alert(`‚úÖ Errore inviato!\n\nEvent ID: ${eventId}\n\nControlla: https://proximity.sentry.io`);
                }, 500);

            } catch (error) {
                log('‚ùå Errore durante invio', { error: error.message });
                updateStatus('error', '‚ùå Errore durante invio');
                console.error('Test error:', error);
            }
        }

        function testWithContext() {
            if (!sentryReady) {
                alert('Sentry non ancora pronto!');
                return;
            }

            try {
                log('üöÄ Test 2: Invio errore con contesto...');
                updateStatus('loading', '‚è≥ Invio errore con contesto...');

                Sentry.withScope((scope) => {
                    scope.setTag('test_type', 'with_context');
                    scope.setLevel('warning');
                    scope.setContext('test_data', {
                        timestamp: new Date().toISOString(),
                        browser: navigator.userAgent,
                        page: 'test_sentry_simple.html'
                    });

                    const eventId = Sentry.captureMessage('Test con contesto aggiuntivo', 'warning');
                    
                    log('‚úÖ Errore con contesto inviato!', { eventId });
                    updateStatus('success', `‚úÖ Errore inviato! Event ID: ${eventId}`);
                    
                    setTimeout(() => {
                        alert(`‚úÖ Errore con contesto inviato!\n\nEvent ID: ${eventId}`);
                    }, 500);
                });

            } catch (error) {
                log('‚ùå Errore durante invio', { error: error.message });
                updateStatus('error', '‚ùå Errore durante invio');
                console.error('Test error:', error);
            }
        }

        function testException() {
            if (!sentryReady) {
                alert('Sentry non ancora pronto!');
                return;
            }

            try {
                log('üöÄ Test 3: Generazione exception reale...');
                updateStatus('loading', '‚è≥ Generazione exception...');

                // Genera un'eccezione reale
                throw new Error('Test Exception da Proximity - Questo √® un errore di test!');

            } catch (error) {
                const eventId = Sentry.captureException(error);
                
                log('‚úÖ Exception catturata e inviata!', { 
                    eventId, 
                    error: error.message 
                });
                updateStatus('success', `‚úÖ Exception inviata! Event ID: ${eventId}`);
                
                setTimeout(() => {
                    alert(`‚úÖ Exception inviata!\n\nEvent ID: ${eventId}\n\nMessaggio: ${error.message}`);
                }, 500);
            }
        }

        // Auto-init on load
        window.addEventListener('load', () => {
            console.log('Page loaded, waiting for Sentry SDK...');
        });
    </script>

    <!-- Sentry SDK - loaded AFTER function definitions -->
    <script 
        src="https://browser.sentry-cdn.com/8.40.0/bundle.min.js" 
        crossorigin="anonymous"
        onload="initSentry()"
        onerror="handleSdkError()"
    ></script>
</body>
</html>
